<?xml version="1.0" encoding="UTF-8"?>
<project>
  <actions/>
  <description/>
  <keepDependencies>false</keepDependencies>
  <properties>
    <jenkins.model.BuildDiscarderProperty>
      <strategy class="hudson.tasks.LogRotator">
        <daysToKeep>-1</daysToKeep>
        <numToKeep>10</numToKeep>
        <artifactDaysToKeep>10</artifactDaysToKeep>
        <artifactNumToKeep>10</artifactNumToKeep>
      </strategy>
    </jenkins.model.BuildDiscarderProperty>
    <hudson.plugins.throttleconcurrents.ThrottleJobProperty plugin="throttle-concurrents@1.9.0">
      <maxConcurrentPerNode>0</maxConcurrentPerNode>
      <maxConcurrentTotal>0</maxConcurrentTotal>
      <categories class="java.util.concurrent.CopyOnWriteArrayList"/>
      <throttleEnabled>false</throttleEnabled>
      <throttleOption>project</throttleOption>
      <limitOneJobWithMatchingParams>false</limitOneJobWithMatchingParams>
      <paramsToUseForLimit/>
    </hudson.plugins.throttleconcurrents.ThrottleJobProperty>
  </properties>
  <scm class="hudson.scm.NullSCM"/>
  <canRoam>true</canRoam>
  <disabled>false</disabled>
  <blockBuildWhenDownstreamBuilding>false</blockBuildWhenDownstreamBuilding>
  <blockBuildWhenUpstreamBuilding>false</blockBuildWhenUpstreamBuilding>
  <triggers/>
  <concurrentBuild>false</concurrentBuild>
  <builders>
    <hudson.tasks.Shell>
      <command>cd /cyrusworks/cyrus-docker/

git checkout cyrusworks_place_DockerImage_here;

WEEK_STRING=$(date "+%y-%V")

cp ./cyrusworks_place_DockerImage_here ./cyrusworks_place_DockerImage_here.tmp

sudo mkdir -p /CyrusWorksLogs/${JOB_NAME}-build${BUILD_NUMBER}/

sudo chmod 777 /CyrusWorksLogs/${JOB_NAME}-build${BUILD_NUMBER}/

sed -i "s#CyrusWorksWeeklyInvalidationString#$WEEK_STRING#g" ./cyrusworks_place_DockerImage_here.tmp

sudo docker build -t cyrusworks_place_DockerImage_here:build${BUILD_NUMBER} - &lt; cyrusworks_place_DockerImage_here.tmp

sudo docker run -e CYRUSWORKS_BUILD="${JOB_NAME}-build${BUILD_NUMBER}" -h ${JOB_NAME}-build${BUILD_NUMBER} --volumes-from cyrusworks-jenkins $CYRUSWORKS_BUILD cyrusworks_place_DockerImage_here:build${BUILD_NUMBER}

sudo tar --warning=no-file-ignored -zcf ~jenkins/workspace/master-cyrusworks_place_DockerImage_here/build${BUILD_NUMBER}.tar.gz /CyrusWorksLogs/${JOB_NAME}-build${BUILD_NUMBER}/


echo "Cassandane logs : https://cyrus.works/job/master-cyrusworks_place_DockerImage_here/ws/build${BUILD_NUMBER}.tar.gz"

#Remove temp log files as these have been moved to the /ws/ dir as a .tar:
sudo rm -rf /CyrusWorksLogs/${JOB_NAME}-build${BUILD_NUMBER}/

</command>
    </hudson.tasks.Shell>
  </builders>
  <publishers>
    <hudson.plugins.logparser.LogParserPublisher plugin="log-parser@2.0">
      <unstableOnWarning>false</unstableOnWarning>
      <failBuildOnError>true</failBuildOnError>
      <showGraphs>false</showGraphs>
      <parsingRulesPath>/cyrusworks/scripts/cyrusworksrules</parsingRulesPath>
      <useProjectRule>false</useProjectRule>
    </hudson.plugins.logparser.LogParserPublisher>
    <hudson.tasks.Mailer plugin="mailer@1.19">
      <recipients>jenkins@cyrus.works</recipients>
      <dontNotifyEveryUnstableBuild>true</dontNotifyEveryUnstableBuild>
      <sendToIndividuals>false</sendToIndividuals>
    </hudson.tasks.Mailer>
  </publishers>
  <buildWrappers/>
</project>
